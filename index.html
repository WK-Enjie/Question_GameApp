<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore Curriculum Quiz Game</title>
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        /* CONTAINER */
        .container {
            width: 100%;
            max-width: 550px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        /* SCREEN */
        .screen {
            padding: 30px 25px;
            width: 100%;
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* HEADER */
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: #4cc9f0;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #a0aec0;
            font-size: 1rem;
        }
        
        /* 6-DIGIT PIN DISPLAY */
        .pin-display {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .pin-digit {
            width: 55px;
            height: 75px;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid #4cc9f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .pin-separator {
            display: flex;
            align-items: center;
            color: #a0aec0;
            font-size: 1.5rem;
            margin: 0 2px;
        }
        
        /* PIN GUIDE */
        .pin-guide {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #fbbf24;
        }
        
        .pin-guide h4 {
            color: #fbbf24;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .pin-format {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .pin-group {
            text-align: center;
            margin: 0 5px;
        }
        
        .pin-label {
            width: 55px;
            text-align: center;
            font-size: 0.85rem;
            color: #a0aec0;
            margin-bottom: 3px;
        }
        
        .pin-label span {
            display: block;
            color: #4cc9f0;
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }
        
        .group-label {
            color: #48bb78;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* KEYPAD */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .keypad-btn {
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .keypad-btn:active {
            background: rgba(76, 201, 240, 0.3);
            transform: scale(0.98);
        }
        
        .keypad-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .keypad-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        /* QUIZ CATALOG */
        .quiz-catalog {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .quiz-catalog h3 {
            text-align: center;
            color: #a0aec0;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .level-section {
            margin-bottom: 20px;
        }
        
        .level-title {
            color: #4cc9f0;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(76, 201, 240, 0.3);
        }
        
        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 8px;
        }
        
        .quiz-item {
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quiz-item:hover {
            background: rgba(76, 201, 240, 0.1);
            border-color: #4cc9f0;
        }
        
        .quiz-code {
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .quiz-name {
            font-size: 0.85rem;
            margin-bottom: 3px;
            line-height: 1.3;
        }
        
        .quiz-meta {
            font-size: 0.75rem;
            color: #a0aec0;
        }
        
        /* LOADING SCREEN */
        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(76, 201, 240, 0.1);
            border-top-color: #4cc9f0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            color: #a0aec0;
            font-size: 1.2rem;
        }
        
        /* GAME SCREEN (Keep existing styles) */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .quiz-title {
            font-size: 1.4rem;
            color: #4cc9f0;
        }
        
        .home-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .players {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .player {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .player.active {
            border-color: #4cc9f0;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .player h3 {
            color: #a0aec0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .question-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .question-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .question {
            font-size: 1.4rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        
        .option:active {
            background: rgba(76, 201, 240, 0.2);
        }
        
        .option.selected {
            background: rgba(76, 201, 240, 0.2);
            border-color: #4cc9f0;
        }
        
        .answer-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        
        .treasure-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .treasure-section h3 {
            color: #4cc9f0;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .treasure-boxes {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .treasure-box {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .treasure-box:active {
            transform: scale(0.95);
        }
        
        .next-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* ERROR SCREEN */
        .error-icon {
            text-align: center;
            font-size: 4rem;
            color: #f56565;
            margin: 20px 0;
        }
        
        .error-text {
            text-align: center;
            color: #a0aec0;
            margin: 20px 0;
            line-height: 1.5;
        }
        
        .error-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .error-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .retry-btn {
            background: #48bb78;
            color: white;
        }
        
        .back-btn {
            background: #4cc9f0;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PIN SCREEN -->
        <div id="pin-screen" class="screen active">
            <div class="header">
                <h1>üìö Singapore Curriculum Quiz</h1>
                <p>Enter 6-digit code or select a quiz below</p>
            </div>
            
            <!-- 6-DIGIT PIN DISPLAY -->
            <div class="pin-display">
                <div class="pin-digit" id="digit1">_</div>
                <div class="pin-digit" id="digit2">_</div>
                <div class="pin-digit" id="digit3">_</div>
                <div class="pin-separator">-</div>
                <div class="pin-digit" id="digit4">_</div>
                <div class="pin-digit" id="digit5">_</div>
                <div class="pin-separator">-</div>
                <div class="pin-digit" id="digit6">_</div>
            </div>
            
            <!-- PIN GUIDE -->
            <div class="pin-guide">
                <h4>üìù PIN Format: ABC-DE-F</h4>
                <div class="pin-format">
                    <div class="pin-group">
                        <div class="pin-label"><span>A</span>Level<br>1=Primary<br>2=Lower Sec<br>3=Upper Sec</div>
                        <div class="pin-label"><span>B</span>Subject<br>0=Math<br>1=Sci<br>4=Chem<br>2=Phys</div>
                        <div class="pin-label"><span>C</span>Grade<br>1=P1/S1<br>5=P5<br>2=S2</div>
                        <div class="group-label">Subject Code</div>
                    </div>
                    <div class="pin-group">
                        <div class="pin-label"><span>D</span>Ch<br>10s</div>
                        <div class="pin-label"><span>E</span>Ch<br>1s</div>
                        <div class="group-label">Chapter (01-99)</div>
                    </div>
                    <div class="pin-group">
                        <div class="pin-label"><span>F</span>WS<br>1-9</div>
                        <div class="group-label">Worksheet</div>
                    </div>
                </div>
                <div style="color: #a0aec0; font-size: 0.85rem; text-align: center; margin-top: 10px;">
                    Example: <strong>342-10-1</strong> = Sec 4 Comb Sci Chem, Chapter 10, Worksheet 1
                </div>
            </div>
            
            <div class="keypad">
                <button class="keypad-btn" data-digit="1">1</button>
                <button class="keypad-btn" data-digit="2">2</button>
                <button class="keypad-btn" data-digit="3">3</button>
                <button class="keypad-btn" data-digit="4">4</button>
                <button class="keypad-btn" data-digit="5">5</button>
                <button class="keypad-btn" data-digit="6">6</button>
                <button class="keypad-btn" data-digit="7">7</button>
                <button class="keypad-btn" data-digit="8">8</button>
                <button class="keypad-btn" data-digit="9">9</button>
                <button class="keypad-btn" data-digit="0">0</button>
            </div>
            
            <div class="keypad-actions">
                <button id="clear-btn" class="clear-btn">
                    <span style="font-size: 1.3rem;">√ó</span> Clear
                </button>
                <button id="submit-pin-btn" class="submit-btn">
                    GO <span style="font-size: 1.3rem;">‚ñ∂</span>
                </button>
            </div>
            
            <!-- QUIZ CATALOG -->
            <div id="quiz-catalog" class="quiz-catalog">
                <!-- Populated by JavaScript -->
                <div style="text-align: center; color: #a0aec0; padding: 20px;">
                    Loading quiz catalog...
                </div>
            </div>
        </div>
        
        <!-- Other screens remain the same -->
        <!-- LOADING SCREEN -->
        <div id="loading-screen" class="screen">
            <div class="loader"></div>
            <div class="loading-text" id="loading-text">Loading questions...</div>
        </div>
        
        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <!-- Same game screen HTML as before -->
            <div class="game-header">
                <div>
                    <div class="quiz-title" id="quiz-title">Quiz Game</div>
                    <div style="color: #a0aec0; font-size: 0.9rem;" id="quiz-topic">Topic</div>
                </div>
                <button id="home-btn" class="home-btn">Home</button>
            </div>
            
            <div class="players">
                <div class="player active" id="player1">
                    <h3>Player 1</h3>
                    <div class="score" id="score1">0</div>
                </div>
                <div class="player" id="player2">
                    <h3>Player 2</h3>
                    <div class="score" id="score2">0</div>
                </div>
            </div>
            
            <div class="question-info">
                <div>Question: <span id="current-q">1</span>/<span id="total-q">10</span></div>
                <div>Points: <span id="points">10</span></div>
            </div>
            
            <div class="question-box">
                <div class="question" id="question">What is the chemical symbol for water?</div>
                <div class="options" id="options"></div>
                <button id="submit-answer" class="answer-btn">Submit Answer</button>
                <div class="feedback" id="feedback"></div>
            </div>
            
            <div class="treasure-section">
                <h3>üéÅ Treasure Boxes</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Pick one after correct answer!</p>
                <div class="treasure-boxes">
                    <div class="treasure-box" data-box="1">üéÅ</div>
                    <div class="treasure-box" data-box="2">üéÅ</div>
                    <div class="treasure-box" data-box="3">üéÅ</div>
                </div>
                <div id="powerup-result" style="color: #a0aec0; margin-top: 15px;">
                    Answer correctly to unlock treasure!
                </div>
            </div>
            
            <button id="next-btn" class="next-btn" style="display: none;">Next Question ‚Üí</button>
            
            <!-- GAME OVER -->
            <div id="game-over" class="game-over" style="display: none;">
                <h2>üéâ Game Over! üéâ</h2>
                <div class="winner" id="winner">Player 1 Wins!</div>
                <div class="final-scores">
                    <div class="final-score-box">
                        <h4>Player 1</h4>
                        <div class="final-score" id="final-score1">0</div>
                    </div>
                    <div class="final-score-box">
                        <h4>Player 2</h4>
                        <div class="final-score" id="final-score2">0</div>
                    </div>
                </div>
                <div class="game-over-actions">
                    <button id="restart-game" class="restart-btn">Restart</button>
                    <button id="new-chapter" class="new-chapter-btn">New Chapter</button>
                </div>
            </div>
        </div>
        
        <!-- ERROR SCREEN -->
        <div id="error-screen" class="screen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 style="text-align: center;">Something went wrong</h2>
            <div class="error-text" id="error-message">No question set found. Please check your code.</div>
            <div class="error-actions">
                <button id="retry-btn" class="retry-btn">Try Again</button>
                <button id="back-btn" class="back-btn">Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // ========== ENHANCED GAME STATE ==========
        const gameState = {
            pin: '',
            questions: [],
            currentQuestion: 0,
            currentPlayer: 1,
            scores: [0, 0],
            selectedAnswer: null,
            answered: false,
            powerupUsed: false,
            canUsePowerup: false,
            availableQuizzes: []
        };

        // ========== POWER-UPS ==========
        const powerUps = [
            { icon: '‚ö°', name: 'Double Points', type: 'double' },
            { icon: '‚ûó', name: 'Half Points', type: 'half' },
            { icon: '‚ûñ', name: 'Negative Points', type: 'negative' },
            { icon: 'üîÑ', name: 'Switch Scores', type: 'switch' },
            { icon: '‚ú®', name: 'Bonus +10', type: 'bonus' }
        ];

        // ========== 6-DIGIT QUIZ CATALOG ==========
        const QUIZ_CATALOG = [
            // PRIMARY MATHEMATICS (1XX-XX-X)
            { code: '105011', level: 'Primary', grade: 'P5', subject: 'Mathematics', 
              folder: 'primary/math', name: 'P5 Math - Ch 1: Whole Numbers - WS 1' },
            { code: '105012', level: 'Primary', grade: 'P5', subject: 'Mathematics', 
              folder: 'primary/math', name: 'P5 Math - Ch 1: Whole Numbers - WS 2' },
            { code: '105021', level: 'Primary', grade: 'P5', subject: 'Mathematics', 
              folder: 'primary/math', name: 'P5 Math - Ch 2: Fractions - WS 1' },
            { code: '105101', level: 'Primary', grade: 'P5', subject: 'Mathematics', 
              folder: 'primary/math', name: 'P5 Math - Ch 10: Geometry - WS 1' },
            { code: '105102', level: 'Primary', grade: 'P5', subject: 'Mathematics', 
              folder: 'primary/math', name: 'P5 Math - Ch 10: Geometry - WS 2' },
            
            // PRIMARY SCIENCE (11X-XX-X)
            { code: '115011', level: 'Primary', grade: 'P5', subject: 'Science', 
              folder: 'primary/science', name: 'P5 Science - Ch 1: Cells - WS 1' },
            { code: '115101', level: 'Primary', grade: 'P5', subject: 'Science', 
              folder: 'primary/science', name: 'P5 Science - Ch 10: Energy - WS 1' },
            
            // UPPER SECONDARY COMBINED SCI CHEM (342-XX-X)
            { code: '342011', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 1: Periodic Table - WS 1' },
            { code: '342012', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 1: Periodic Table - WS 2' },
            { code: '342021', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 2: Chemical Bonding - WS 1' },
            { code: '342022', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 2: Chemical Bonding - WS 2' },
            { code: '342101', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 10: Organic Chemistry - WS 1' },
            { code: '342102', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 10: Organic Chemistry - WS 2' },
            { code: '342111', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 11: Electrochemistry - WS 1' },
            { code: '342112', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Combined Science (Chemistry)', 
              folder: 'upper-secondary/combined-chem', name: 'Sec 4 Comb Sci Chem - Ch 11: Electrochemistry - WS 2' },
            
            // UPPER SECONDARY PURE CHEMISTRY (312-XX-X)
            { code: '312011', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Pure Chemistry', 
              folder: 'upper-secondary/pure-chem', name: 'Sec 4 Pure Chem - Ch 1: Atomic Structure - WS 1' },
            { code: '312101', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Pure Chemistry', 
              folder: 'upper-secondary/pure-chem', name: 'Sec 4 Pure Chem - Ch 10: Organic Chem - WS 1' },
            
            // UPPER SECONDARY PURE PHYSICS (322-XX-X)
            { code: '322011', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Pure Physics', 
              folder: 'upper-secondary/pure-physics', name: 'Sec 4 Pure Physics - Ch 1: Kinematics - WS 1' },
            { code: '322101', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Pure Physics', 
              folder: 'upper-secondary/pure-physics', name: 'Sec 4 Pure Physics - Ch 10: Waves - WS 1' },
            { code: '322111', level: 'Upper Secondary', grade: 'Sec 4', subject: 'Pure Physics', 
              folder: 'upper-secondary/pure-physics', name: 'Sec 4 Pure Physics - Ch 11: Electricity - WS 1' }
        ];

        // ========== SCREEN MANAGEMENT ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ========== 6-DIGIT PIN FUNCTIONS ==========
        function updatePinDisplay() {
            const digits = ['digit1', 'digit2', 'digit3', 'digit4', 'digit5', 'digit6'];
            digits.forEach((id, index) => {
                const digit = document.getElementById(id);
                digit.textContent = gameState.pin[index] || '_';
            });
        }

        function addDigit(digit) {
            if (gameState.pin.length < 6) {
                gameState.pin += digit;
                updatePinDisplay();
            }
        }

        function clearPin() {
            gameState.pin = '';
            updatePinDisplay();
        }

        // Format PIN for display (add dashes)
        function formatPin(pin) {
            if (pin.length >= 6) {
                return `${pin.substring(0,3)}-${pin.substring(3,5)}-${pin.substring(5,6)}`;
            }
            return pin;
        }

        // ========== LOAD QUIZ FUNCTION ==========
        async function loadQuizByCode(code) {
            // Find quiz in catalog
            const quizInfo = QUIZ_CATALOG.find(q => q.code === code);
            
            if (!quizInfo) {
                return { 
                    success: false, 
                    error: `Quiz code ${formatPin(code)} not found.` 
                };
            }
            
            const filename = `Questions/${quizInfo.folder}/${code}.json`;
            console.log('Loading from:', filename);
            
            try {
                const response = await fetch(filename);
                
                if (!response.ok) {
                    return { 
                        success: false, 
                        error: `Quiz file not found: ${filename}` 
                    };
                }
                
                const data = await response.json();
                return { 
                    success: true, 
                    data: data, 
                    info: quizInfo 
                };
                
            } catch (error) {
                console.error('Error loading quiz:', error);
                return { 
                    success: false, 
                    error: `Failed to load: ${error.message}` 
                };
            }
        }

        // ========== SUBMIT PIN ==========
        async function submitPin() {
            let pinToUse = gameState.pin;
            
            if (pinToUse.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }
            
            // Validate code format
            if (!/^[1-3][0-9]{5}$/.test(pinToUse)) {
                alert('Invalid code. First digit must be 1, 2, or 3.');
                return;
            }
            
            // Extract chapter from digits 4-5
            const chapter = parseInt(pinToUse.substring(3, 5));
            if (chapter < 1 || chapter > 99) {
                alert('Invalid chapter number (must be 01-99)');
                return;
            }
            
            showScreen('loading-screen');
            document.getElementById('loading-text').textContent = `Loading ${formatPin(pinToUse)}...`;
            
            try {
                const result = await loadQuizByCode(pinToUse);
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                gameState.questions = result.data.questions;
                
                // Set quiz info
                const quizTitle = document.getElementById('quiz-title');
                const quizTopic = document.getElementById('quiz-topic');
                
                quizTitle.textContent = result.data.title || result.info.name;
                
                // Build topic string
                let topic = `${result.info.grade} ${result.info.subject}`;
                if (result.data.chapter) {
                    topic += ` | Chapter ${result.data.chapter}`;
                } else {
                    // Extract chapter from PIN
                    const chapterFromPin = parseInt(pinToUse.substring(3, 5));
                    topic += ` | Chapter ${chapterFromPin}`;
                }
                if (result.data.worksheet) {
                    topic += ` | Worksheet ${result.data.worksheet}`;
                } else {
                    // Extract worksheet from PIN
                    const worksheetFromPin = pinToUse.substring(5, 6);
                    topic += ` | Worksheet ${worksheetFromPin}`;
                }
                if (result.data.topic) {
                    topic += ` | ${result.data.topic}`;
                }
                if (result.data.difficulty) {
                    topic += ` | ${result.data.difficulty}`;
                }
                
                quizTopic.textContent = topic;
                
                // Initialize game
                initGame();
                showScreen('game-screen');
                
                // Save to recent quizzes
                saveToRecentQuizzes(pinToUse, result.data.title || result.info.name, 
                                   result.info.subject, result.info.grade);
                
            } catch (error) {
                console.error('Failed to load quiz:', error);
                
                // Find similar quizzes (same subject code)
                const subjectCode = pinToUse.substring(0, 3);
                const similarQuizzes = QUIZ_CATALOG.filter(q => 
                    q.code.startsWith(subjectCode)
                ).slice(0, 5);
                
                let suggestion = '';
                if (similarQuizzes.length > 0) {
                    suggestion = `<br><br>Available ${similarQuizzes[0].grade} ${similarQuizzes[0].subject} worksheets:`;
                    similarQuizzes.forEach(q => {
                        // Format nicely: 342-10-1
                        const formattedCode = `${q.code.substring(0,3)}-${q.code.substring(3,5)}-${q.code.substring(5,6)}`;
                        suggestion += `<br>‚Ä¢ <strong>${formattedCode}</strong>: ${q.name}`;
                    });
                }
                
                document.getElementById('error-message').innerHTML = 
                    `<strong>Worksheet ${formatPin(pinToUse)} not found</strong>${suggestion}`;
                showScreen('error-screen');
            }
        }

        // ========== GAME FUNCTIONS ==========
        function initGame() {
            gameState.currentQuestion = 0;
            gameState.currentPlayer = 1;
            gameState.scores = [0, 0];
            gameState.selectedAnswer = null;
            gameState.answered = false;
            gameState.powerupUsed = false;
            gameState.canUsePowerup = false;
            
            updateScores();
            updatePlayerTurn();
            loadQuestion();
            
            document.getElementById('game-over').style.display = 'none';
        }

        function loadQuestion() {
            const question = gameState.questions[gameState.currentQuestion];
            
            document.getElementById('current-q').textContent = gameState.currentQuestion + 1;
            document.getElementById('total-q').textContent = gameState.questions.length;
            document.getElementById('points').textContent = question.points;
            document.getElementById('question').textContent = question.question;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionElement);
            });
            
            // Reset UI
            gameState.selectedAnswer = null;
            gameState.answered = false;
            gameState.powerupUsed = false;
            gameState.canUsePowerup = false;
            
            const submitBtn = document.getElementById('submit-answer');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submit Answer';
            
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-btn').style.display = 'none';
            
            // Reset treasure boxes
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.textContent = 'üéÅ';
                box.style.background = 'linear-gradient(135deg, #fbbf24, #d97706)';
                box.onclick = () => openTreasureBox(box.dataset.box);
            });
            
            document.getElementById('powerup-result').innerHTML = 
                'Answer correctly to unlock treasure!';
            document.getElementById('powerup-result').style.color = '#a0aec0';
        }

        function selectOption(index) {
            if (gameState.answered) return;
            
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            const options = document.querySelectorAll('.option');
            options[index].classList.add('selected');
            gameState.selectedAnswer = index;
            
            // Enable submit button
            document.getElementById('submit-answer').disabled = false;
        }

        function submitAnswer() {
            if (gameState.answered || gameState.selectedAnswer === null) return;
            
            gameState.answered = true;
            const submitBtn = document.getElementById('submit-answer');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Answered';
            
            const question = gameState.questions[gameState.currentQuestion];
            const isCorrect = gameState.selectedAnswer === question.correct;
            gameState.canUsePowerup = isCorrect;
            
            // Show correct/incorrect answers
            const options = document.querySelectorAll('.option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.style.background = 'rgba(72, 187, 120, 0.3)';
                    opt.style.border = '2px solid #48bb78';
                } else if (index === gameState.selectedAnswer && !isCorrect) {
                    opt.style.background = 'rgba(245, 101, 101, 0.3)';
                    opt.style.border = '2px solid #f56565';
                }
            });
            
            // Update score if correct
            if (isCorrect) {
                gameState.scores[gameState.currentPlayer - 1] += question.points;
                updateScores();
                
                let feedback = `<div style="color: #48bb78; font-weight: bold; margin-bottom: 10px;">
                    ‚úì Correct! +${question.points} points
                </div>`;
                
                if (question.explanation) {
                    feedback += `<div style="color: #a0aec0;">üí° ${question.explanation}</div>`;
                }
                
                document.getElementById('feedback').innerHTML = feedback;
                
            } else {
                let feedback = `<div style="color: #f56565; font-weight: bold; margin-bottom: 10px;">
                    ‚úó Incorrect! No points
                </div>
                <div style="color: #48bb78; margin-bottom: 10px;">
                    Correct answer: ${question.options[question.correct]}
                </div>`;
                
                if (question.explanation) {
                    feedback += `<div style="color: #a0aec0;">üí° ${question.explanation}</div>`;
                }
                
                document.getElementById('feedback').innerHTML = feedback;
                
                // Disable treasure boxes for wrong answers
                document.querySelectorAll('.treasure-box').forEach(box => {
                    box.textContent = 'üîí';
                    box.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
                    box.onclick = null;
                });
                
                document.getElementById('powerup-result').innerHTML = 
                    'No power-up for wrong answers!';
                document.getElementById('powerup-result').style.color = '#f56565';
                
                // Show next button immediately
                document.getElementById('next-btn').style.display = 'block';
            }
        }

        function openTreasureBox(boxNum) {
            if (!gameState.canUsePowerup || gameState.powerupUsed) return;
            
            gameState.powerupUsed = true;
            
            // Mark all boxes as opened
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
                box.onclick = null;
            });
            
            // Random power-up
            const powerUp = powerUps[Math.floor(Math.random() * powerUps.length)];
            
            // Update selected box
            const selectedBox = document.querySelector(`.treasure-box[data-box="${boxNum}"]`);
            selectedBox.textContent = powerUp.icon;
            
            // Show result
            document.getElementById('powerup-result').innerHTML = 
                `<strong>${powerUp.name}</strong><br>${powerUp.icon}`;
            document.getElementById('powerup-result').style.color = '#fbbf24';
            
            // Apply power-up
            applyPowerUp(powerUp.type);
            
            // Show next button
            document.getElementById('next-btn').style.display = 'block';
        }

        function applyPowerUp(type) {
            const playerIndex = gameState.currentPlayer - 1;
            const otherIndex = playerIndex === 0 ? 1 : 0;
            const question = gameState.questions[gameState.currentQuestion];
            let points = question.points;
            
            switch(type) {
                case 'double':
                    points *= 2;
                    gameState.scores[playerIndex] += points;
                    break;
                case 'half':
                    points = Math.floor(points / 2);
                    gameState.scores[playerIndex] += points;
                    break;
                case 'negative':
                    gameState.scores[playerIndex] -= points;
                    break;
                case 'switch':
                    const temp = gameState.scores[playerIndex];
                    gameState.scores[playerIndex] = gameState.scores[otherIndex];
                    gameState.scores[otherIndex] = temp;
                    break;
                case 'bonus':
                    gameState.scores[playerIndex] += 10;
                    break;
            }
            
            // Ensure score doesn't go below 0
            if (gameState.scores[playerIndex] < 0) {
                gameState.scores[playerIndex] = 0;
            }
            
            updateScores();
        }

        function updateScores() {
            document.getElementById('score1').textContent = gameState.scores[0];
            document.getElementById('score2').textContent = gameState.scores[1];
        }

        function updatePlayerTurn() {
            const player1 = document.getElementById('player1');
            const player2 = document.getElementById('player2');
            
            if (gameState.currentPlayer === 1) {
                player1.classList.add('active');
                player2.classList.remove('active');
            } else {
                player1.classList.remove('active');
                player2.classList.add('active');
            }
        }

        function nextQuestion() {
            gameState.currentQuestion++;
            
            if (gameState.currentQuestion >= gameState.questions.length) {
                endGame();
                return;
            }
            
            // Switch player
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            
            loadQuestion();
            updatePlayerTurn();
        }

        function endGame() {
            // Determine winner
            let winner = '';
            if (gameState.scores[0] > gameState.scores[1]) {
                winner = 'Player 1 Wins! üèÜ';
            } else if (gameState.scores[1] > gameState.scores[0]) {
                winner = 'Player 2 Wins! üèÜ';
            } else {
                winner = "It's a Tie! ü§ù";
            }
            
            document.getElementById('winner').textContent = winner;
            document.getElementById('final-score1').textContent = gameState.scores[0];
            document.getElementById('final-score2').textContent = gameState.scores[1];
            
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
        }

        // ========== RECENT QUIZZES ==========
        function saveToRecentQuizzes(code, title, subject, grade) {
            let recent = JSON.parse(localStorage.getItem('recentQuizzes') || '[]');
            
            // Remove if already exists
            recent = recent.filter(q => q.code !== code);
            
            // Add to beginning
            recent.unshift({ 
                code: code, 
                title: title,
                subject: subject,
                grade: grade,
                timestamp: Date.now() 
            });
            
            // Keep only last 8
            recent = recent.slice(0, 8);
            
            localStorage.setItem('recentQuizzes', JSON.stringify(recent));
        }

        function showRecentQuizzes() {
            const recent = JSON.parse(localStorage.getItem('recentQuizzes') || '[]');
            
            if (recent.length > 0) {
                const container = document.createElement('div');
                container.className = 'recent-quizzes';
                container.innerHTML = `
                    <div style="color: #a0aec0; margin: 20px 0 10px 0; font-weight: bold;">
                        ‚è∞ Recently Played
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
                        ${recent.map(quiz => {
                            // Get icon based on subject
                            let icon = 'üìö';
                            if (quiz.subject.includes('Math')) icon = 'üßÆ';
                            if (quiz.subject.includes('Science') && !quiz.subject.includes('Chem') && !quiz.subject.includes('Phys')) icon = 'üî¨';
                            if (quiz.subject.includes('Chem')) icon = 'üß™';
                            if (quiz.subject.includes('Phys')) icon = '‚öõÔ∏è';
                            
                            // Format code with dashes
                            const formattedCode = formatPin(quiz.code);
                            
                            return `
                                <button class="recent-btn" data-code="${quiz.code}" 
                                        style="background: rgba(76, 201, 240, 0.1); 
                                               border: 1px solid #4cc9f0; 
                                               border-radius: 8px; 
                                               padding: 10px; 
                                               color: white; 
                                               cursor: pointer;
                                               text-align: left;">
                                    <div style="font-weight: bold; color: #fbbf24;">${icon} ${formattedCode}</div>
                                    <div style="font-size: 0.85rem; margin-top: 3px;">${quiz.subject}</div>
                                    <div style="font-size: 0.75rem; color: #a0aec0;">${quiz.grade}</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                `;
                
                // Insert after PIN guide
                const pinGuide = document.querySelector('.pin-guide');
                if (pinGuide) {
                    pinGuide.parentNode.insertBefore(container, pinGuide.nextSibling);
                }
                
                // Add click handlers
                container.querySelectorAll('.recent-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        gameState.pin = btn.dataset.code;
                        updatePinDisplay();
                    });
                });
            }
        }

        // ========== QUIZ CATALOG DISPLAY ==========
        function showQuizCatalog() {
            const catalogContainer = document.getElementById('quiz-catalog');
            if (!catalogContainer) return;
            
            // Group by level
            const levels = {
                'Primary': QUIZ_CATALOG.filter(q => q.level === 'Primary'),
                'Lower Secondary': QUIZ_CATALOG.filter(q => q.level === 'Lower Secondary'),
                'Upper Secondary': QUIZ_CATALOG.filter(q => q.level === 'Upper Secondary')
            };
            
            let html = '<h3>üìö Available Worksheets</h3>';
            
            // Create catalog for each level
            Object.keys(levels).forEach(level => {
                const quizzes = levels[level];
                if (quizzes.length === 0) return;
                
                // Group by subject within level
                const subjects = {};
                quizzes.forEach(quiz => {
                    if (!subjects[quiz.subject]) subjects[quiz.subject] = [];
                    subjects[quiz.subject].push(quiz);
                });
                
                html += `
                    <div class="level-section">
                        <div class="level-title">${level}</div>
                `;
                
                Object.keys(subjects).forEach(subject => {
                    const subjectQuizzes = subjects[subject];
                    
                    // Group by chapter
                    const byChapter = {};
                    subjectQuizzes.forEach(quiz => {
                        const chapter = parseInt(quiz.code.substring(3, 5));
                        if (!byChapter[chapter]) byChapter[chapter] = [];
                        byChapter[chapter].push(quiz);
                    });
                    
                    // Sort chapters numerically
                    const sortedChapters = Object.keys(byChapter).sort((a, b) => a - b);
                    
                    html += `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #a0aec0; font-size: 0.9rem; margin-bottom: 8px; padding-left: 5px;">
                                ${subject}:
                            </div>
                    `;
                    
                    sortedChapters.forEach(chapter => {
                        const chapterQuizzes = byChapter[chapter];
                        
                        html += `
                            <div style="margin-bottom: 10px;">
                                <div style="color: #48bb78; font-size: 0.85rem; margin-bottom: 5px;">
                                    Chapter ${chapter}:
                                </div>
                                <div class="quiz-grid">
                        `;
                        
                        chapterQuizzes.forEach(quiz => {
                            let icon = 'üìö';
                            if (quiz.subject.includes('Math')) icon = 'üßÆ';
                            if (quiz.subject.includes('Science') && !quiz.subject.includes('Chem') && !quiz.subject.includes('Phys')) icon = 'üî¨';
                            if (quiz.subject.includes('Chem')) icon = 'üß™';
                            if (quiz.subject.includes('Phys')) icon = '‚öõÔ∏è';
                            
                            // Format code with dashes
                            const formattedCode = formatPin(quiz.code);
                            
                            html += `
                                <div class="quiz-item" data-code="${quiz.code}">
                                    <div class="quiz-code">${icon} ${formattedCode}</div>
                                    <div class="quiz-name">${quiz.name}</div>
                                    <div class="quiz-meta">${quiz.grade}</div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            catalogContainer.innerHTML = html;
            
            // Add click handlers
            catalogContainer.querySelectorAll('.quiz-item').forEach(item => {
                item.addEventListener('click', () => {
                    gameState.pin = item.dataset.code;
                    updatePinDisplay();
                    // Scroll to top
                    document.querySelector('.pin-display').scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize PIN display
            updatePinDisplay();
            
            // Show quiz catalog
            showQuizCatalog();
            
            // Show recent quizzes
            showRecentQuizzes();
            
            // Check for URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            if (codeParam && codeParam.length === 6 && /^[1-3][0-9]{5}$/.test(codeParam)) {
                gameState.pin = codeParam;
                updatePinDisplay();
                setTimeout(() => submitPin(), 800);
            }
            
            // ========== EVENT LISTENERS ==========
            // PIN buttons
            document.querySelectorAll('.keypad-btn').forEach(btn => {
                btn.addEventListener('click', () => addDigit(btn.dataset.digit));
            });
            
            document.getElementById('clear-btn').addEventListener('click', clearPin);
            document.getElementById('submit-pin-btn').addEventListener('click', submitPin);
            
            // Game buttons
            document.getElementById('submit-answer').addEventListener('click', submitAnswer);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('home-btn').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Error buttons
            document.getElementById('retry-btn').addEventListener('click', submitPin);
            document.getElementById('back-btn').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Game over buttons
            document.getElementById('restart-game').addEventListener('click', initGame);
            document.getElementById('new-chapter').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Treasure boxes
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.addEventListener('click', () => openTreasureBox(box.dataset.box));
            });
            
            // Keyboard support
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('pin-screen').classList.contains('active')) {
                    if (e.key >= '0' && e.key <= '9') {
                        addDigit(e.key);
                    } else if (e.key === 'Backspace') {
                        clearPin();
                    } else if (e.key === 'Enter') {
                        submitPin();
                    }
                }
            });
            
            console.log('Singapore Curriculum Quiz Game Ready!');
            console.log('Available quizzes:', QUIZ_CATALOG.length);
        });

        // ========== ADMIN TOOLS ==========
        window.quizAdmin = {
            // Generate template for new worksheet
            generateTemplate: function(code, subject, grade, level, chapter, worksheet, folder) {
                // Ensure code is 6 digits
                let paddedCode = code;
                if (paddedCode.length !== 6) {
                    // Pad chapter with leading zero if needed
                    const chapterStr = chapter.toString().padStart(2, '0');
                    // Reconstruct code
                    const subjectCode = paddedCode.substring(0, 3);
                    paddedCode = subjectCode + chapterStr + worksheet;
                }
                
                const template = {
                    "title": `${grade} ${subject} - Worksheet ${worksheet}`,
                    "topic": `${subject} - Chapter ${chapter}`,
                    "subject": subject,
                    "level": level,
                    "grade": grade,
                    "chapter": chapter,
                    "worksheet": worksheet,
                    "author": "Teacher",
                    "dateCreated": new Date().toISOString().split('T')[0],
                    "difficulty": "Medium",
                    "estimatedTime": "15 minutes",
                    "questions": [
                        {
                            "question": "Sample question 1?",
                            "options": ["Option A", "Option B", "Option C", "Option D"],
                            "correct": 0,
                            "points": 10,
                            "explanation": "Explanation for correct answer.",
                            "learningObjective": "Understand basic concept"
                        }
                    ]
                };
                
                console.log(`=== TEMPLATE FOR WORKSHEET ${formatPin(paddedCode)} ===`);
                console.log(`Save as: Questions/${folder}/${paddedCode}.json`);
                console.log(JSON.stringify(template, null, 2));
                console.log(`=== END TEMPLATE ===`);
                
                return template;
            },
            
            // List worksheets by chapter range
            listBySubject: function(subjectCode) {
                // subjectCode like "342" for Sec 4 Combined Sci Chem
                const worksheets = QUIZ_CATALOG.filter(q => q.code.startsWith(subjectCode));
                
                console.log(`=== WORKSHEETS FOR ${subjectCode}XXX ===`);
                if (worksheets.length === 0) {
                    console.log('No worksheets found');
                } else {
                    // Group by chapter
                    const byChapter = {};
                    worksheets.forEach(ws => {
                        const chapter = parseInt(ws.code.substring(3, 5));
                        if (!byChapter[chapter]) byChapter[chapter] = [];
                        byChapter[chapter].push(ws);
                    });
                    
                    // Sort chapters numerically
                    const sortedChapters = Object.keys(byChapter).sort((a, b) => a - b);
                    
                    sortedChapters.forEach(chapter => {
                        console.log(`\nChapter ${chapter}:`);
                        byChapter[chapter].forEach(ws => {
                            console.log(`  ${formatPin(ws.code)}: ${ws.name}`);
                        });
                    });
                }
            },
            
            // Find next available code
            findNextCode: function(subjectCode, chapter) {
                // Find all existing codes for this subject and chapter
                const existingCodes = QUIZ_CATALOG
                    .filter(q => q.code.startsWith(subjectCode) && 
                           parseInt(q.code.substring(3, 5)) === chapter)
                    .map(q => parseInt(q.code.substring(5, 6)))
                    .sort((a, b) => a - b);
                
                // Find next available worksheet number
                let nextWorksheet = 1;
                for (let i = 1; i <= 9; i++) {
                    if (!existingCodes.includes(i)) {
                        nextWorksheet = i;
                        break;
                    }
                }
                
                const chapterStr = chapter.toString().padStart(2, '0');
                const newCode = subjectCode + chapterStr + nextWorksheet;
                
                console.log(`Next available code: ${formatPin(newCode)}`);
                console.log(`(Chapter ${chapter}, Worksheet ${nextWorksheet})`);
                
                return newCode;
            }
        };
    </script>
</body>
</html>