<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science & Math Quiz Game</title>
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        /* CONTAINER */
        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        /* SCREEN - Only one shows at a time */
        .screen {
            padding: 30px 25px;
            width: 100%;
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* HEADER */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #4cc9f0;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #a0aec0;
            font-size: 1.1rem;
        }
        
        /* PIN DISPLAY */
        .pin-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .pin-digit {
            width: 70px;
            height: 90px;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid #4cc9f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        /* KEYPAD */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .keypad-btn {
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1.8rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .keypad-btn:active {
            background: rgba(76, 201, 240, 0.3);
            transform: scale(0.98);
        }
        
        .keypad-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .keypad-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        /* QUICK CODES */
        .quick-codes {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .quick-codes h3 {
            text-align: center;
            color: #a0aec0;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .code-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .code-item {
            padding: 14px 10px;
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid #4cc9f0;
            border-radius: 10px;
            text-align: center;
            color: #4cc9f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .code-item:active {
            background: rgba(76, 201, 240, 0.2);
            transform: translateY(-2px);
        }
        
        /* LOADING SCREEN */
        .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(76, 201, 240, 0.1);
            border-top-color: #4cc9f0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            color: #a0aec0;
            font-size: 1.2rem;
        }
        
        /* ERROR SCREEN */
        .error-icon {
            text-align: center;
            font-size: 4rem;
            color: #f56565;
            margin: 20px 0;
        }
        
        .error-text {
            text-align: center;
            color: #a0aec0;
            margin: 20px 0;
            line-height: 1.5;
        }
        
        .error-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .error-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .retry-btn {
            background: #48bb78;
            color: white;
        }
        
        .back-btn {
            background: #4cc9f0;
            color: white;
        }
        
        /* GAME SCREEN */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .quiz-title {
            font-size: 1.4rem;
            color: #4cc9f0;
        }
        
        .home-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .players {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .player {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .player.active {
            border-color: #4cc9f0;
            background: rgba(76, 201, 240, 0.1);
        }
        
        .player h3 {
            color: #a0aec0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .question-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .question-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .question {
            font-size: 1.4rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        
        .option:active {
            background: rgba(76, 201, 240, 0.2);
        }
        
        .option.selected {
            background: rgba(76, 201, 240, 0.2);
            border-color: #4cc9f0;
        }
        
        .answer-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        
        .treasure-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .treasure-section h3 {
            color: #4cc9f0;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .treasure-boxes {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .treasure-box {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .treasure-box:active {
            transform: scale(0.95);
        }
        
        .next-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* GAME OVER */
        .game-over {
            text-align: center;
            padding: 30px 20px;
        }
        
        .game-over h2 {
            font-size: 2rem;
            color: #fbbf24;
            margin-bottom: 20px;
        }
        
        .winner {
            font-size: 2rem;
            color: #4cc9f0;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .final-scores {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }
        
        .final-score-box {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
        }
        
        .final-score-box h4 {
            color: #a0aec0;
            margin-bottom: 10px;
        }
        
        .final-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .game-over-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .game-over-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .restart-btn {
            background: #48bb78;
            color: white;
        }
        
        .new-chapter-btn {
            background: #4cc9f0;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PIN SCREEN -->
        <div id="pin-screen" class="screen active">
            <div class="header">
                <h1>Science & Math Quiz</h1>
                <p>Enter 3-digit code to access question set</p>
            </div>
            
            <div class="pin-display">
                <div class="pin-digit" id="digit1">_</div>
                <div class="pin-digit" id="digit2">_</div>
                <div class="pin-digit" id="digit3">_</div>
            </div>
            
            <div class="keypad">
                <button class="keypad-btn" data-digit="1">1</button>
                <button class="keypad-btn" data-digit="2">2</button>
                <button class="keypad-btn" data-digit="3">3</button>
                <button class="keypad-btn" data-digit="4">4</button>
                <button class="keypad-btn" data-digit="5">5</button>
                <button class="keypad-btn" data-digit="6">6</button>
                <button class="keypad-btn" data-digit="7">7</button>
                <button class="keypad-btn" data-digit="8">8</button>
                <button class="keypad-btn" data-digit="9">9</button>
            </div>
            
            <div class="keypad-actions">
                <button id="clear-btn" class="clear-btn">
                    <span style="font-size: 1.3rem;">√ó</span> Clear
                </button>
                <button id="submit-pin-btn" class="submit-btn">
                    GO <span style="font-size: 1.3rem;">‚ñ∂</span>
                </button>
            </div>
            
            <div class="quick-codes">
                <h3>Quick Access Codes:</h3>
                <div class="code-grid">
                    <div class="code-item" data-code="101">101 - Chemistry</div>
                    <div class="code-item" data-code="102">102 - Chemistry</div>
                    <div class="code-item" data-code="103">103 - Chemistry</div>
                    <div class="code-item" data-code="201">201 - Math (Easy)</div>
                    <div class="code-item" data-code="202">202 - Math (Hard)</div>
                </div>
                <p style="text-align: center; color: #fbbf24; margin-top: 15px; font-size: 0.9rem;">
                    First digit: 1=Chemistry, 2=Mathematics
                </p>
            </div>
        </div>
        
        <!-- LOADING SCREEN -->
        <div id="loading-screen" class="screen">
            <div class="loader"></div>
            <div class="loading-text" id="loading-text">Loading questions...</div>
        </div>
        
        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div>
                    <div class="quiz-title" id="quiz-title">Quiz Game</div>
                    <div style="color: #a0aec0; font-size: 0.9rem;" id="quiz-topic">Topic</div>
                </div>
                <button id="home-btn" class="home-btn">Home</button>
            </div>
            
            <div class="players">
                <div class="player active" id="player1">
                    <h3>Player 1</h3>
                    <div class="score" id="score1">0</div>
                </div>
                <div class="player" id="player2">
                    <h3>Player 2</h3>
                    <div class="score" id="score2">0</div>
                </div>
            </div>
            
            <div class="question-info">
                <div>Question: <span id="current-q">1</span>/<span id="total-q">10</span></div>
                <div>Points: <span id="points">10</span></div>
            </div>
            
            <div class="question-box">
                <div class="question" id="question">What is the chemical symbol for water?</div>
                <div class="options" id="options"></div>
                <button id="submit-answer" class="answer-btn">Submit Answer</button>
                <div class="feedback" id="feedback"></div>
            </div>
            
            <div class="treasure-section">
                <h3>üéÅ Treasure Boxes</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Pick one after correct answer!</p>
                <div class="treasure-boxes">
                    <div class="treasure-box" data-box="1">üéÅ</div>
                    <div class="treasure-box" data-box="2">üéÅ</div>
                    <div class="treasure-box" data-box="3">üéÅ</div>
                </div>
                <div id="powerup-result" style="color: #a0aec0; margin-top: 15px;">
                    Answer correctly to unlock treasure!
                </div>
            </div>
            
            <button id="next-btn" class="next-btn" style="display: none;">Next Question ‚Üí</button>
            
            <!-- GAME OVER - Hidden by default -->
            <div id="game-over" class="game-over" style="display: none;">
                <h2>üéâ Game Over! üéâ</h2>
                <div class="winner" id="winner">Player 1 Wins!</div>
                <div class="final-scores">
                    <div class="final-score-box">
                        <h4>Player 1</h4>
                        <div class="final-score" id="final-score1">0</div>
                    </div>
                    <div class="final-score-box">
                        <h4>Player 2</h4>
                        <div class="final-score" id="final-score2">0</div>
                    </div>
                </div>
                <div class="game-over-actions">
                    <button id="restart-game" class="restart-btn">Restart</button>
                    <button id="new-chapter" class="new-chapter-btn">New Chapter</button>
                </div>
            </div>
        </div>
        
        <!-- ERROR SCREEN -->
        <div id="error-screen" class="screen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 style="text-align: center;">Something went wrong</h2>
            <div class="error-text" id="error-message">No question set found. Please check your code.</div>
            <div class="error-actions">
                <button id="retry-btn" class="retry-btn">Try Again</button>
                <button id="back-btn" class="back-btn">Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // GAME STATE
        const gameState = {
            pin: '',
            questions: [],
            currentQuestion: 0,
            currentPlayer: 1,
            scores: [0, 0],
            selectedAnswer: null,
            answered: false,
            powerupUsed: false,
            canUsePowerup: false
        };

        // POWER-UPS
        const powerUps = [
            { icon: '‚ö°', name: 'Double Points', type: 'double' },
            { icon: '‚ûó', name: 'Half Points', type: 'half' },
            { icon: '‚ûñ', name: 'Negative Points', type: 'negative' },
            { icon: 'üîÑ', name: 'Switch Scores', type: 'switch' },
            { icon: '‚ú®', name: 'Bonus +10', type: 'bonus' }
        ];

        // SCREEN MANAGEMENT
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // PIN FUNCTIONS
        function updatePinDisplay() {
            const digits = ['digit1', 'digit2', 'digit3'];
            digits.forEach((id, index) => {
                const digit = document.getElementById(id);
                digit.textContent = gameState.pin[index] || '_';
            });
        }

        function addDigit(digit) {
            if (gameState.pin.length < 3) {
                gameState.pin += digit;
                updatePinDisplay();
            }
        }

        function clearPin() {
            gameState.pin = '';
            updatePinDisplay();
        }

        async function submitPin() {
            if (gameState.pin.length !== 3) {
                alert('Please enter 3 digits');
                return;
            }

            showScreen('loading-screen');
            
            try {
                const firstDigit = gameState.pin[0];
                let folder = '';
                
                if (firstDigit === '1') folder = 'chem/';
                else if (firstDigit === '2') folder = 'math/';
                else {
                    alert('First digit must be 1 or 2');
                    clearPin();
                    showScreen('pin-screen');
                    return;
                }

                const response = await fetch(`Questions/${folder}${gameState.pin}.json`);
                
                if (!response.ok) {
                    throw new Error('Question set not found');
                }

                const data = await response.json();
                gameState.questions = data.questions;
                
                // Set quiz info
                document.getElementById('quiz-title').textContent = data.title || 'Quiz Game';
                document.getElementById('quiz-topic').textContent = data.topic || 'General Knowledge';
                
                // Initialize game
                initGame();
                showScreen('game-screen');
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error-message').textContent = 
                    `No question set found for code: ${gameState.pin}`;
                showScreen('error-screen');
            }
        }

        // GAME FUNCTIONS
        function initGame() {
            gameState.currentQuestion = 0;
            gameState.currentPlayer = 1;
            gameState.scores = [0, 0];
            gameState.selectedAnswer = null;
            gameState.answered = false;
            gameState.powerupUsed = false;
            gameState.canUsePowerup = false;
            
            updateScores();
            updatePlayerTurn();
            loadQuestion();
            
            document.getElementById('game-over').style.display = 'none';
        }

        function loadQuestion() {
            const question = gameState.questions[gameState.currentQuestion];
            
            document.getElementById('current-q').textContent = gameState.currentQuestion + 1;
            document.getElementById('total-q').textContent = gameState.questions.length;
            document.getElementById('points').textContent = question.points;
            document.getElementById('question').textContent = question.question;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionElement);
            });
            
            // Reset UI
            gameState.selectedAnswer = null;
            gameState.answered = false;
            gameState.powerupUsed = false;
            gameState.canUsePowerup = false;
            
            const submitBtn = document.getElementById('submit-answer');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submit Answer';
            
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('next-btn').style.display = 'none';
            
            // Reset treasure boxes
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.textContent = 'üéÅ';
                box.style.background = 'linear-gradient(135deg, #fbbf24, #d97706)';
                box.onclick = () => openTreasureBox(box.dataset.box);
            });
            
            document.getElementById('powerup-result').innerHTML = 
                'Answer correctly to unlock treasure!';
            document.getElementById('powerup-result').style.color = '#a0aec0';
        }

        function selectOption(index) {
            if (gameState.answered) return;
            
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Select new option
            const options = document.querySelectorAll('.option');
            options[index].classList.add('selected');
            gameState.selectedAnswer = index;
            
            // Enable submit button
            document.getElementById('submit-answer').disabled = false;
        }

        function submitAnswer() {
            if (gameState.answered || gameState.selectedAnswer === null) return;
            
            gameState.answered = true;
            const submitBtn = document.getElementById('submit-answer');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Answered';
            
            const question = gameState.questions[gameState.currentQuestion];
            const isCorrect = gameState.selectedAnswer === question.correct;
            gameState.canUsePowerup = isCorrect;
            
            // Show correct/incorrect answers
            const options = document.querySelectorAll('.option');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.style.background = 'rgba(72, 187, 120, 0.3)';
                    opt.style.border = '2px solid #48bb78';
                } else if (index === gameState.selectedAnswer && !isCorrect) {
                    opt.style.background = 'rgba(245, 101, 101, 0.3)';
                    opt.style.border = '2px solid #f56565';
                }
            });
            
            // Update score if correct
            if (isCorrect) {
                gameState.scores[gameState.currentPlayer - 1] += question.points;
                updateScores();
                
                let feedback = `<div style="color: #48bb78; font-weight: bold; margin-bottom: 10px;">
                    ‚úì Correct! +${question.points} points
                </div>`;
                
                if (question.explanation) {
                    feedback += `<div style="color: #a0aec0;">üí° ${question.explanation}</div>`;
                }
                
                document.getElementById('feedback').innerHTML = feedback;
                
            } else {
                let feedback = `<div style="color: #f56565; font-weight: bold; margin-bottom: 10px;">
                    ‚úó Incorrect! No points
                </div>
                <div style="color: #48bb78; margin-bottom: 10px;">
                    Correct answer: ${question.options[question.correct]}
                </div>`;
                
                if (question.explanation) {
                    feedback += `<div style="color: #a0aec0;">üí° ${question.explanation}</div>`;
                }
                
                document.getElementById('feedback').innerHTML = feedback;
                
                // Disable treasure boxes for wrong answers
                document.querySelectorAll('.treasure-box').forEach(box => {
                    box.textContent = 'üîí';
                    box.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
                    box.onclick = null;
                });
                
                document.getElementById('powerup-result').innerHTML = 
                    'No power-up for wrong answers!';
                document.getElementById('powerup-result').style.color = '#f56565';
                
                // Show next button immediately
                document.getElementById('next-btn').style.display = 'block';
            }
        }

        function openTreasureBox(boxNum) {
            if (!gameState.canUsePowerup || gameState.powerupUsed) return;
            
            gameState.powerupUsed = true;
            
            // Mark all boxes as opened
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
                box.onclick = null;
            });
            
            // Random power-up
            const powerUp = powerUps[Math.floor(Math.random() * powerUps.length)];
            
            // Update selected box
            const selectedBox = document.querySelector(`.treasure-box[data-box="${boxNum}"]`);
            selectedBox.textContent = powerUp.icon;
            
            // Show result
            document.getElementById('powerup-result').innerHTML = 
                `<strong>${powerUp.name}</strong><br>${powerUp.icon}`;
            document.getElementById('powerup-result').style.color = '#fbbf24';
            
            // Apply power-up
            applyPowerUp(powerUp.type);
            
            // Show next button
            document.getElementById('next-btn').style.display = 'block';
        }

        function applyPowerUp(type) {
            const playerIndex = gameState.currentPlayer - 1;
            const otherIndex = playerIndex === 0 ? 1 : 0;
            const question = gameState.questions[gameState.currentQuestion];
            let points = question.points;
            
            switch(type) {
                case 'double':
                    points *= 2;
                    gameState.scores[playerIndex] += points;
                    break;
                case 'half':
                    points = Math.floor(points / 2);
                    gameState.scores[playerIndex] += points;
                    break;
                case 'negative':
                    gameState.scores[playerIndex] -= points;
                    break;
                case 'switch':
                    const temp = gameState.scores[playerIndex];
                    gameState.scores[playerIndex] = gameState.scores[otherIndex];
                    gameState.scores[otherIndex] = temp;
                    break;
                case 'bonus':
                    gameState.scores[playerIndex] += 10;
                    break;
            }
            
            // Ensure score doesn't go below 0
            if (gameState.scores[playerIndex] < 0) {
                gameState.scores[playerIndex] = 0;
            }
            
            updateScores();
        }

        function updateScores() {
            document.getElementById('score1').textContent = gameState.scores[0];
            document.getElementById('score2').textContent = gameState.scores[1];
        }

        function updatePlayerTurn() {
            const player1 = document.getElementById('player1');
            const player2 = document.getElementById('player2');
            
            if (gameState.currentPlayer === 1) {
                player1.classList.add('active');
                player2.classList.remove('active');
            } else {
                player1.classList.remove('active');
                player2.classList.add('active');
            }
        }

        function nextQuestion() {
            gameState.currentQuestion++;
            
            if (gameState.currentQuestion >= gameState.questions.length) {
                endGame();
                return;
            }
            
            // Switch player
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            
            loadQuestion();
            updatePlayerTurn();
        }

        function endGame() {
            // Determine winner
            let winner = '';
            if (gameState.scores[0] > gameState.scores[1]) {
                winner = 'Player 1 Wins! üèÜ';
            } else if (gameState.scores[1] > gameState.scores[0]) {
                winner = 'Player 2 Wins! üèÜ';
            } else {
                winner = "It's a Tie! ü§ù";
            }
            
            document.getElementById('winner').textContent = winner;
            document.getElementById('final-score1').textContent = gameState.scores[0];
            document.getElementById('final-score2').textContent = gameState.scores[1];
            
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
        }

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            // PIN buttons
            document.querySelectorAll('.keypad-btn').forEach(btn => {
                btn.addEventListener('click', () => addDigit(btn.dataset.digit));
            });
            
            document.getElementById('clear-btn').addEventListener('click', clearPin);
            document.getElementById('submit-pin-btn').addEventListener('click', submitPin);
            
            // Quick codes
            document.querySelectorAll('.code-item').forEach(item => {
                item.addEventListener('click', () => {
                    gameState.pin = item.dataset.code;
                    updatePinDisplay();
                });
            });
            
            // Game buttons
            document.getElementById('submit-answer').addEventListener('click', submitAnswer);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('home-btn').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Error buttons
            document.getElementById('retry-btn').addEventListener('click', submitPin);
            document.getElementById('back-btn').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Game over buttons
            document.getElementById('restart-game').addEventListener('click', initGame);
            document.getElementById('new-chapter').addEventListener('click', () => {
                gameState.pin = '';
                showScreen('pin-screen');
            });
            
            // Treasure boxes
            document.querySelectorAll('.treasure-box').forEach(box => {
                box.addEventListener('click', () => openTreasureBox(box.dataset.box));
            });
            
            // Keyboard support
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('pin-screen').classList.contains('active')) {
                    if (e.key >= '0' && e.key <= '9') {
                        addDigit(e.key);
                    } else if (e.key === 'Backspace') {
                        clearPin();
                    } else if (e.key === 'Enter') {
                        submitPin();
                    }
                }
            });
            
            console.log('Game ready!');
        });
    </script>
</body>
</html>